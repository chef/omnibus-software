# GitHub Copilot Instructions

This document provides a comprehensive guide for GitHub Copilot and all contributors working in this repository. **Strict adherence is required to ensure quality, compliance, and seamless integration with the Chef/Omnibus ecosystem.**

---

## 1. Repository Analysis & Structure

### Project Purpose

This repository contains Omnibus software definitions and build scripts for Chef and related tools. It automates the building, packaging, and distribution of Chef and its dependencies, ensuring consistency and reproducibility across platforms.

### Folder Structure Diagram

```
omnibus-software/
├── config/
│   └── software/         # Omnibus software definitions (Ruby DSL)
├── files/                # Static files used in builds
├── test/                 # Unit and integration tests (RSpec)
│   ├── Gemfile           # Test dependencies
│   └── ...               # Test helpers/specs
├── .expeditor/           # Expeditor build automation config
├── .github/              # GitHub workflows, templates, Copilot instructions
│   └── copilot-instructions.md
├── CODEOWNERS            # Code ownership rules
├── README.md             # Project overview
├── ...                   # Other root files (Gemfile, Rakefile, etc.)
```

### Technologies Used

- **Ruby** (Omnibus DSL, build scripts)
- **Chef/Omnibus** (build automation)
- **RSpec** (testing)
- **Expeditor** (release automation)
- **Bash** (build/test scripts)
- **YAML** (configuration)
- **GitHub Actions** (CI/CD, if present)

### File Modification Guidelines

- **Safe to Modify:**  
  - `config/software/*.rb` (add/update software definitions)
  - `test/**/*` (add/update tests)
  - `.github/` (workflows, docs, Copilot instructions)
- **Prohibited:**  
  - Files auto-generated by Omnibus or Expeditor (see `.expeditor/README.md`)
  - Files with explicit warnings (e.g., "DO NOT EDIT" in header)
  - License files, unless updating license text
- **Never Modify:**  
  - Files in `vendor/` or `embedded/` directories
  - Any file with "expeditor/ignore" or similar comment

### Code Generation Patterns

- Omnibus generates build artifacts—**never modify generated binaries or vendor directories**.
- Chefstyle and Expeditor may auto-generate changelogs or version bumps.

---

## 2. Development Workflow Integration

### Jira Integration (atlassian-mcp-server MCP)

- When a Jira ID is provided, fetch issue details using the MCP server.
- Read the story, clarify requirements, and plan implementation.

### Workflow Phases

#### Phase 1: Initial Setup & Analysis
- Fetch Jira issue details.
- Analyze repository structure and dependencies.
- Plan implementation and testing approach.
- **Prompt:**  
  _"Phase 1 complete. Ready to proceed to implementation. Do you want me to continue with Phase 2? Remaining: Implementation, Testing, PR."_

#### Phase 2: Implementation Phase
- Implement the required code changes.
- Update documentation as needed.
- **Prompt:**  
  _"Phase 2 complete. Ready to proceed to testing. Do you want me to continue with Phase 3? Remaining: Testing, PR."_

#### Phase 3: Testing Phase
- Write comprehensive unit tests (**>80% coverage required**).
- Run tests and validate results.
- **Prompt:**  
  _"Phase 3 complete. Ready to proceed to PR creation. Do you want me to continue with Phase 4? Remaining: PR."_

#### Phase 4: Pull Request Creation
- Use Jira ID as branch name.
- Commit with DCO signoff.
- Push and create PR with GH CLI.
- **Prompt:**  
  _"Phase 4 complete. Task finished. Please review the PR."_

---

## 3. Testing Requirements (**CRITICAL**)

- **MANDATORY:** All code changes must include comprehensive unit tests.
- **>80% test coverage is a hard requirement.**  
  _No PR will be accepted below this threshold._
- Use RSpec for Ruby code.  
  - Place specs in `test/` or `spec/` as appropriate.
- Test positive, negative, edge, and error cases.
- Use mocks for external dependencies.
- Tests must be independent and order-agnostic.

### Example RSpec Structure

```ruby
# test/config/software/my_software_spec.rb
require "spec_helper"

describe "my_software" do
  it "does something" do
    expect(true).to eq(true)
  end
end
```

### Coverage Verification

- Use [SimpleCov](https://github.com/simplecov-ruby/simplecov) for Ruby:
  - Add to `test/spec_helper.rb`:
    ```ruby
    require 'simplecov'
    SimpleCov.start
    ```
- Run tests and check coverage:
  ```sh
  bundle exec rspec
  open coverage/index.html
  ```

### Test Commands

```sh
cd test
bundle install
bundle exec rspec
```

---

## 4. Pull Request Creation Process

- **Branch name:** Use Jira ID (e.g., `PROJ-123`)
- **Commit:**  
  ```sh
  git checkout -b <JIRA_ID>
  git add .
  git commit --signoff -m "<JIRA_ID>: <description>"
  ```
- **Push:**  
  ```sh
  git push origin <JIRA_ID>
  ```
- **Create PR (GH CLI):**  
  ```sh
  gh pr create --base main --head <JIRA_ID> --title "<JIRA_ID>: <summary>" --body "<html-formatted body>" --label "<appropriate-label>"
  ```

### PR Description Template (HTML)

```html
<b>Summary:</b> Implemented <feature/bugfix> for <component>.<br>
<b>Jira:</b> <a href="https://jira.example.com/browse/PROJ-123">PROJ-123</a><br>
<b>Changes:</b>
<ul>
  <li>Updated ...</li>
  <li>Added ...</li>
</ul>
<b>Testing:</b> RSpec, coverage 92%<br>
<b>Files Modified:</b> config/software/foo.rb, test/foo_spec.rb<br>
```

---

## 5. DCO (Developer Certificate of Origin) Compliance

- **ALL commits must be signed off:**  
  ```sh
  git commit --signoff -m "..."
  ```
- **To fix a missing signoff:**  
  ```sh
  git commit --amend --signoff --no-edit
  ```
- **Builds will fail without DCO signoff.**

---

## 6. Build System Integration Analysis

- **Expeditor:**  
  - Config: `.expeditor/config.yml`
  - Skip labels:  
    - `Expeditor: Skip All`
    - `Expeditor: Skip Version Bump`
    - `Expeditor: Skip Changelog`
  - Use skip labels for docs/test-only changes.
  - Build channels: See `.expeditor/config.yml`
  - Automation triggers: PR merge, label application.

- **Other Build Systems:**  
  - `Rakefile` for Ruby tasks.
  - `Makefile` if present.
  - Dependency management: Bundler (`Gemfile`).

---

## 7. Label Management System

- **List labels with:**  
  ```sh
  gh label list
  ```
- **Common labels:**  
  - `Expeditor: Skip All` (docs, non-code)
  - `Expeditor: Skip Version Bump` (test-only)
  - `Expeditor: Skip Changelog` (minor)
  - `feature`, `enhancement`, `bug`, `test`, `documentation`
- **Decision Matrix:**

| Change Type      | Label(s) to Use                |
|------------------|-------------------------------|
| Documentation    | Expeditor: Skip All, docs      |
| Feature          | enhancement, feature           |
| Bug Fix          | bug                           |
| Test-only        | Expeditor: Skip Version Bump   |

---

## 8. Prompt-Based Execution Protocol

- **After each major step:**  
  _"Step X complete. Next: Step Y. Do you want me to continue? Remaining: ..."_
- **Wait for user approval before proceeding.**
- **Example:**

  ```
  Phase 1 complete: Jira analysis and planning done.
  Next: Implementation.
  Do you want me to continue with Phase 2?
  Remaining: Implementation, Testing, PR.
  ```

---

## 9. Repository-Specific Guidelines

- **Build system:** Omnibus, Expeditor, Bundler, RSpec.
- **Dependency management:** Bundler (`Gemfile`).
- **Prohibited modifications:**  
  - Vendor/embedded files
  - Auto-generated files
  - License files (except for legal updates)
- **Platform considerations:**  
  - Linux, macOS, Windows (see software definitions for platform-specific logic)
- **Special integrations:**  
  - Jira (via MCP)
  - Expeditor

---

## 10. Code Quality & Standards

- **Style:** Chefstyle (Ruby), enforced via CI.
- **Linting:**  
  ```sh
  bundle exec chefstyle
  ```
- **Security:**  
  - No hardcoded secrets.
  - FIPS compliance where required.
- **License:** Apache 2.0 headers required.
- **Performance:** Avoid unnecessary shell-outs, prefer native Ruby.
- **Code review:**  
  - See `CODEOWNERS` for required reviewers.

---

## 11. Security and Compliance Requirements

- **CVE awareness:** Monitor dependencies for vulnerabilities.
- **FIPS compliance:** Required for cryptographic components.
- **License headers:** All files must include Apache 2.0 header.
- **Security scanning:** Use tools like Brakeman, Bundler Audit.

---

## 12. Build & Development Environment

- **Local setup:**  
  ```sh
  bundle install
  ```
- **Build commands:**  
  ```sh
  bundle exec omnibus build <project>
  ```
- **Containerization:** Use Docker/Habitat as needed.
- **Cross-platform:** Use Omnibus platform logic.
- **IDE:** VS Code recommended; see `.vscode/` if present.
- **Troubleshooting:**  
  - Missing dependencies: `bundle install`
  - Build failures: Check logs in `omnibus/logs/`

---

## 13. Integration & Dependencies

- **Ecosystem integration:** Chef, Expeditor, Jira, MCP.
- **External dependencies:** RubyGems, system packages.
- **API/database:** Not applicable unless defined in software scripts.
- **MCP server:** Used for Jira integration.

---

## 14. Release & CI/CD Awareness

- **Automated pipelines:** Expeditor, GitHub Actions.
- **Release channels:** Defined in `.expeditor/config.yml`.
- **Versioning:** Automated via Expeditor.
- **Notifications:** Slack/email as configured in Expeditor.
- **Manual releases:** See Expeditor docs.

---

## 15. Code Ownership & Review Process

- **CODEOWNERS:** Defines required reviewers for each directory/file.
- **Review process:**  
  - All PRs require review by code owners.
  - Security/critical files may require additional approvals.

---

## 16. Important Development Notes

- **All work is performed locally.**
- **Ask for clarification if requirements are unclear.**
- **Never modify prohibited files.**
- **Troubleshooting:**  
  - Build/test failures: Check logs, dependencies, and environment.
- **Available commands:**  
  - `bundle exec omnibus build <project>`
  - `bundle exec rspec`
  - `bundle exec chefstyle`

---

## 17. Example Workflow Execution

### Example: Feature Implementation

**User:**  
_"Implement PROJ-123: Add new build flag to ruby.rb"_

**Copilot:**  
```
Phase 1 complete: Jira analysis and planning done.
Next: Implementation.
Do you want me to continue with Phase 2?
Remaining: Implementation, Testing, PR.
```
**User:**  
_"Yes, continue."_

**Copilot:**  
```
Phase 2 complete: Code changes made in config/software/ruby.rb.
Next: Testing.
Do you want me to continue with Phase 3?
Remaining: Testing, PR.
```
**User:**  
_"Yes."_

**Copilot:**  
```
Phase 3 complete: Tests added in test/config/software/ruby_spec.rb, coverage 92%.
Next: PR creation.
Do you want me to continue with Phase 4?
Remaining: PR.
```
**User:**  
_"Yes."_

**Copilot:**  
```
Phase 4 complete: PR created as PROJ-123.
Please review the PR.
```

---

## 18. Technology-Specific Guidelines

### Ruby

- **Bundler:** Use `bundle install` for dependencies.
- **RSpec:** Place specs in `test/` or `spec/`.
- **Chefstyle:** Run `bundle exec chefstyle`.
- **Gem management:** Use `Gemfile` for dependencies.

### Go, Node.js, Python, Java

- Not detected in this repo. If added, follow standard patterns for each.

---

## 19. Advanced Configuration Management

- **Configuration files:**  
  - `.expeditor/config.yml` (build automation)
  - `.github/workflows/` (CI/CD)
- **Environment variables:**  
  - `OMNIBUS_INSTALL_DIR`, `PATH`, etc.
- **Secret management:**  
  - Never commit secrets; use environment variables or secret stores.
- **Database/service config:**  
  - Not applicable unless defined in software scripts.

---

## Validation Checklist

- [x] Repository structure diagram
- [x] DCO signoff requirements in all commit examples
- [x] >80% test coverage requirement mentioned multiple times
- [x] Actual repository labels (not generic)
- [x] Build system integration (Expeditor, etc.)
- [x] Prompt-based workflow examples
- [x] Technology-specific testing patterns
- [x] Complete Git workflow with proper commands
- [x] Security and compliance requirements
- [x] Troubleshooting section
- [x] Example interaction patterns

---

**Maintain these standards for all contributions. For questions, ask for clarification before proceeding.**