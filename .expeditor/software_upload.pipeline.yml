steps:
- label: ":file_folder: upload software to internal sources"
  agents:
    queue: default
  plugins:
    - docker#v3.5.0:
        image: chefes/omnibus-toolchain-ubuntu-2204-x86
        shell:
          - "/bin/bash"
          - "-e"
          - "-c"
        propagate-environment: true
  environment:
    ARTIFACTORY_TOKEN: "${ARTIFACTORY_TOKEN}"
    ARTIFACTORY_PASSWORD: "${ARTIFACTORY_PASSWORD}"
    VAULT_ADDR: "https://vault.ps.chef.co"
  commands:
    - export VAULT_TOKEN=$(vault login -method=aws -path=aws/private-cd -token-only header_value=vault.ps.chef.co role=ci)
    - export ARTIFACTORY_TOKEN=$(vault kv get -field token account/static/artifactory/buildkite)
    - export ARTIFACTORY_PASSWORD=$ARTIFACTORY_TOKEN
    - echo "Artifactory token length: ${#ARTIFACTORY_TOKEN}"
    - export PATH=... && ./scripts/internal_sources.rb ./scripts/internal_sources.yml
  expeditor:
    secrets:
      ARTIFACTORY_TOKEN:
        path: account/static/artifactory/buildkite
        field: token
  timeout_in_minutes: 20
